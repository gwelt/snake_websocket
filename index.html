<!doctype html>
<html>
  <head>
    <title>SNAKE / WebSocket</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font:23px Helvetica, Arial; }
    </style>
  </head>
  <body>
    
    <div id="grid">SNAKE STARTING...<br></div>

    <script>
      var ws=false; //new WebSocket(HOST);
      ws_open(); // AUTO-OPEN
      var snakeID=0;
      var direction;

      function ws_open() {
        if (ws==false) {          
          ws=new WebSocket(location.origin.replace(/^http/, 'ws'));
          ws.onopen = function () {};
          ws.onmessage = function (message) {
            if (message.data.startsWith(':WELCOME PLAYER ')) {
              snakeID=message.data.substr(16);
            }
            else {
              var out="<a href="+location.origin+">"+location.origin+"</a><br>YOU ARE SNAKE #"+snakeID+"<br>";
              var Snakes=JSON.parse(message.data);
              Snakes.forEach(function (s) {
                if (s.id==snakeID) {
                  if (!s.elements.length) {direction=""}
                  out+="YOUR SNAKE (#"+s.id+"): ";
                } 
                else {out+="SNAKE #"+s.id+": ";}
                out+=s.elements;
                out+="<br>";
              });
              document.getElementById('grid').innerHTML=out;
            }
          };
        }
      }

      function send(msg) {if ((msg!=direction) && (ws)) {direction=msg; ws.send(msg)}}
      document.onkeydown = function(event) {
        //if (!(ws)&&(event.keyCode==80)) {ws_open();direction=""} // P (PLAY)
        var keyset=[37,38,39,40,27];
        if ((ws)&&(keyset.indexOf(event.keyCode)>=0)) {
          if      (event.keyCode==37) {send('L')} // LEFT
          else if (event.keyCode==38) {send('U')} // UP
          else if (event.keyCode==39) {send('R')} // RIGHT
          else if (event.keyCode==40) {send('D')} // DOWN
          else if (event.keyCode==27) {send('Q')} // ESC (EXIT) //ws=false;
          event.cancelBubble = true;
          event.returnValue = false;
        }
        return event.returnValue;
      }

    </script>
    
  </body>
</html>
