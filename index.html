<!doctype html>
<html>
  <head>
    <title>SNAKE / WebSocket</title>
    <style>
      * {margin:0;padding:0;box-sizing:border-box;}
      body {font:14px Helvetica, Arial;}
      td {width:10px;height:10px;padding:1px;background-color:#c0c0c0;}
    </style>
  </head>
  <body>
    
    <div id="grid"></div><div id="text"></div>

    <script>
      var ws=ws_open();
      var snakeID, direction;
      var keyset=[37,38,39,40,27];
      var Snakes=[];
      var tweets=[];

      function tweet(t) {
        tweets.push(t);
        while (tweets.length>1) {tweets.splice(0,1)}
        var out="";
        tweets.forEach(function(tt) {out+=tt+"<br>"});
        document.getElementById('text').innerHTML=out;
      }

      function init_grid (dimX,dimY) {
        var out="<table>";
        for (var y=dimY-1;y>=0;y--) {
          out+="<tr>";
          for (var x=0;x<dimX;x++) {
            out+="<td id=X"+x+"Y"+y+"></td>";
          }
          out+="</tr>";
        }
        out+="</table>";
        document.getElementById('grid').innerHTML=out;
      }

      function display_snake (s,col) {s.elements.forEach(function(e){document.getElementById('X'+e[0]+'Y'+e[1]).style.background=col})}
      function get_color (id) {if (id==snakeID) {return '#0000e2'} else {return '#505050'}}

      function ws_open() {
        ws=new WebSocket(location.origin.replace(/^http/, 'ws'));
        ws.onmessage = function (message) {
          if (message.data.startsWith('::ID=')) {snakeID=message.data.substr(5)}
          else if (message.data.startsWith(':')) {tweet(message.data.substr(1))}
          else {
            direction=0; //if ((s.id==snakeID)&&(!s.elements.length)) {direction=0}
            Snakes.forEach(function (s) {display_snake(s,'#d0d0d0')});
            var init=false; if (Snakes.length==0) {init=true};
            Snakes=JSON.parse(message.data);
            if (init) {init_grid(Snakes[0].dim[0],Snakes[0].dim[1])}
            Snakes.forEach(function (s) {display_snake(s,get_color(s.id))});
          }
        }
        return ws;
      }

      function send(new_direction) {if (new_direction!=direction) {direction=new_direction; ws.send(new_direction)}}
      document.onkeydown = function(event) {
        if (keyset.indexOf(event.keyCode)>=0) {
          switch (event.keyCode) {
            case 37: send('L'); break; // LEFT
            case 38: send('U'); break; // UP
            case 39: send('R'); break; // RIGHT
            case 40: send('D'); break; // DOWN
            case 27: send('Q'); break; // ESC (QUIT/START)
          }
          event.cancelBubble = true;
          event.returnValue = false;
        }
        return event.returnValue;
      }

    </script>
    
  </body>
</html>
