<!doctype html>
<html>
  <head>
    <title>SNAKE / WebSocket</title>
  </head>
  <body>
    
    <div id=grid></div>

    <script>
      var ws=ws_open();
      var snakeID, direction;
      var keyset=[37,38,39,40,27];
      var Snakes=[];
      var tweets=[];

      function tweet(t) {
        if (t) {tweets.push(t)}
        while (tweets.length>1) {tweets.splice(0,1)}
        var out="";
        tweets.forEach(function(tt) {out+=tt+"<br>"});
        document.getElementById('text').innerHTML=out;
      }

      function init_grid (dimX,dimY) {
        var grid=document.getElementById("grid");
        grid.style.textAlign='left';
        var gridX=grid.offsetWidth;
        var gridY=grid.offsetHeight;
        var x=Math.floor(gridX/dimX);
        var y=Math.floor(gridY/(dimY));
        if (y==0) {y=x} else if (x<y) {y=x} else {x=y};
        var out="";
        out+="<style>.g {float:left;width:"+x+"px;height:"+y+"px;background-color:#e0e0e0;border:1px solid white;box-sizing:border-box;}</style>";
        out+="<div style='display:inline-block;width:"+x*dimX+"px;height:100%;background-color:#ffffff';>";
        for (var yy=dimY-1;yy>=0;yy--) { out+="<div style=clear:both></div>"; for (var xx=0;xx<dimX;xx++) { out+="<div class=g id=X"+xx+"Y"+yy+"></div>"; } }
        out+="</div><div style=clear:both></div><div id=text style=\"text-align:left;font:"+x+"px 'Lucidia Console', Monaco, monospace\"></div>";
        grid.innerHTML=out; 
      }

      function display_snake (s,col) {
        var opacity=1;
        s.elements.reverse().forEach(function(e) {
          var elem=document.getElementById('X'+e[0]+'Y'+e[1]);
          elem.style.background=col;
          elem.style.opacity=opacity;
          if ((col)&&(opacity>0.5)) {opacity-=0.1;}
        });
      }

      document.onkeydown = function(event) {
        if (keyset.indexOf(event.keyCode)>=0) {
          switch (event.keyCode) {
            case 37: send('L'); break; // LEFT
            case 38: send('U'); break; // UP
            case 39: send('R'); break; // RIGHT
            case 40: send('D'); break; // DOWN
            case 27: send('Q'); break; // ESC (QUIT/START)
          }
          event.cancelBubble = true;
          event.returnValue = false;
        }
        return event.returnValue;
      }

      function send(new_direction) {if (new_direction!=direction) {direction=new_direction; ws.send(new_direction)}}

      function ws_open() {
        ws=new WebSocket(location.origin.replace(/^http/, 'ws'));
        ws.onmessage = function (message) {
          if (message.data.startsWith('::ID=')) {snakeID=message.data.substr(5)}
          else if (message.data.startsWith(':')) {tweet(message.data.substr(1))}
          else {
            Snakes.forEach(function (s) {display_snake(s,null);if ((s.id==snakeID)&&(!s.elements.length)) {direction=0}});
            Snakes=JSON.parse(message.data);
            if (direction==null) {init_grid(Snakes[0].dim[0],Snakes[0].dim[1])}
            Snakes.forEach(function (s) {display_snake(s,(s.id==snakeID)?'#0070C0':'#505050')});
          }
        }
        return ws;
      }

    </script>
    
  </body>
</html>
